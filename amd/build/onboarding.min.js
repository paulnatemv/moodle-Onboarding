define("local_onboarding/onboarding",["core/ajax"],function(Ajax){"use strict";var config={flowId:null,stepId:null,hasVideo:!1,videoRequired:!1,videoCompletion:80,returnUrl:""},videoProgress=0,videoRequirementMet=!1,nextButton=null,progressBar=null,videoNotice=null,ytPlayer=null,progressPollInterval=null,init=function(options){config=Object.assign({},config,options),nextButton=document.getElementById("onboarding-next"),progressBar=document.getElementById("video-progress"),videoNotice=document.getElementById("video-notice"),config.hasVideo&&config.videoRequired?setupVideoTracking():(videoRequirementMet=!0,updateNextButton()),setupKeyboardNav()},setupVideoTracking=function(){var iframe=document.querySelector("#onboarding-video-"+config.stepId);if(!iframe)return videoRequirementMet=!0,void updateNextButton();var src=iframe.src||"";-1!==src.indexOf("youtube.com")||-1!==src.indexOf("youtu.be")?setupYouTubeTracking(iframe):-1!==src.indexOf("vimeo.com")?setupVimeoTracking(iframe):(videoRequirementMet=!0,updateNextButton())},setupYouTubeTracking=function(iframe){window.YT&&window.YT.Player?initYouTubePlayer(iframe):(function(){var tag=document.createElement("script");tag.src="https://www.youtube.com/iframe_api";var firstScriptTag=document.getElementsByTagName("script")[0];firstScriptTag.parentNode.insertBefore(tag,firstScriptTag)}(),window.onboardingIframe=iframe,window.onYouTubeIframeAPIReady=function(){initYouTubePlayer(window.onboardingIframe)})},initYouTubePlayer=function(iframe){try{ytPlayer=new window.YT.Player(iframe,{events:{onReady:onYouTubePlayerReady,onStateChange:onYouTubePlayerStateChange,onError:function(){videoRequirementMet=!0,updateNextButton()}}})}catch(e){videoRequirementMet=!0,updateNextButton()}},onYouTubePlayerReady=function(){startProgressPolling()},onYouTubePlayerStateChange=function(event){1===event.data&&startProgressPolling()},startProgressPolling=function(){progressPollInterval||(progressPollInterval=setInterval(function(){if(ytPlayer)try{var currentTime=ytPlayer.getCurrentTime?ytPlayer.getCurrentTime():0,duration=ytPlayer.getDuration?ytPlayer.getDuration():0;if(duration>0){var percent=currentTime/duration*100;updateVideoProgress(percent)}}catch(e){}videoRequirementMet&&(clearInterval(progressPollInterval),progressPollInterval=null)},1e3))},setupVimeoTracking=function(iframe){var tag=document.createElement("script");tag.src="https://player.vimeo.com/api/player.js",tag.onload=function(){window.Vimeo&&window.Vimeo.Player?new window.Vimeo.Player(iframe).on("timeupdate",function(data){updateVideoProgress(100*data.percent)}):(videoRequirementMet=!0,updateNextButton())},tag.onerror=function(){videoRequirementMet=!0,updateNextButton()},document.head.appendChild(tag)},updateVideoProgress=function(percent){videoProgress=Math.max(videoProgress,percent),progressBar&&(progressBar.style.width=Math.min(videoProgress,100)+"%",progressBar.setAttribute("aria-valuenow",Math.round(videoProgress))),videoProgress>=config.videoCompletion&&!videoRequirementMet&&(videoRequirementMet=!0,updateNextButton(),videoNotice&&(videoNotice.classList.add("completed"),videoNotice.querySelector(".notice-text").innerHTML='<span class="notice-icon">âœ“</span> Great job! You can now continue to the next step.'),saveVideoProgress())},updateNextButton=function(){nextButton&&(nextButton.disabled=!videoRequirementMet,videoRequirementMet&&nextButton.classList.add("btn-ready"))},saveVideoProgress=function(){Ajax.call([{methodname:"local_onboarding_update_video_time",args:{flowid:config.flowId,stepid:config.stepId,seconds:Math.floor(videoProgress)}}])[0].catch(function(){})},setupKeyboardNav=function(){document.addEventListener("keydown",function(event){"Enter"!==event.key&&" "!==event.key||document.activeElement!==nextButton||(nextButton.disabled||nextButton.click(),event.preventDefault())})};return{init:init}});
